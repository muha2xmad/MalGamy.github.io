---
title: Technical analysis of WarZoneRAT malware
classes: wide
header:
  teaser: /assets/images/MA/warzonerat/war.jpg
ribbon: MidnightBlue
categories:
  - Malware-analysis
toc: true
---

**بسم الله الرحمن الرحيم**

**FreePalestine** 


# Introduction 

We will start analyzing **Ave Maria** known as WARZONE RAT. Ave Maria is a Remote Access Trojan (RAT) which provides some capabilities, such as stealing Cookies  stealing passwords, Keylogging (online and offline), Windows Defender Bypass, and Remote WebCam.

We can take a look at what this threat actor provides to its customers from its site warzone[.]ws.

<p align="center">
  <img src="/assets/images/MA/warzonerat/1.png" />
</p>
<center><font size="3"> <u>Figure</u> Screenshot of the RAT capabilities from warzone[.]ws <u></u> </font></center>
<br>
<p align="center">
  <img src="/assets/images/MA/warzonerat/2.png" />
</p>
<center><font size="3"> <u>Figure</u> Screenshot of the RAT capabilities from warzone[.]ws <u></u> </font></center>
<br>


# Technical summary

When the attaker wants to start a command, it will send to the RAT a hex number. Every hex number has a specific action to be done.

- Password and Cookies Recovery: When it comes to RATs, then it has something with browsers and Email clients. The malware will harvist the cookies, passwords, history, and configurations of browsers. And steal passords and configruations of Email clients.

- Keylogging: Any RAT has the capability to log any keystrokes, but Warzone RAT has the two types of Keylogging which are the live keylogger and the offline keylogger.

- Recording audio: The RAT has the capability to record audio and save it to `.wav` file and send it to the C2 server.

- HRDP: This allows the attacter to connect and control the victim's device without knowing or alerting the victim using Hidden RDP.

- Enumerate processes, disks, and files: The malware can enumerate the currently running processes, disks and their types, and files inside a specific directory.

- File Manager: The RAT gives its customers the ability to download and upload files from the victim's computer, execute a file, and delete files. And compress any directory or folder inside the victim's computer using a command and send it to the C2 server.

- Other features: The malware can terminate any process the attacker wants, uninstall itself by terminating its thread and delete itself from registries, restart the device using commands and create a process to check connectivity, and take screen shots from the victim's device.

# Password and Cookies Recovery

Onece the attacker sends the command to the RAT which will be `0x20` in hex, the malware will create a thread to start Password Recovery action. The RAT will start stealing the saved passwords, configurations, cookies, and history from browsers and extract profiles and passwords from some email services. Then encrypt the data and send it to the C2 server then terminate the thread.

First, the malware will steal the Cookies from Chromium-based browsers such as Google chrome and Microsoft edge by quering `select host_key, path, name, encrypted_value, expires_utc, is_httponly, samesite, is_secure from cookies` from the `cookies` table in `Cookies` database and steal Cookies from Mozilla firefox browser by quering `SELECT host, path, name, value, expiry, isHttpOnly, isSecure FROM moz_cookies` from the `moz_cookies` table.\
The `w_query_get_chrome_based_cookies` (`sub_40C5FA`) function uses `SHGetSpecialFolderPathW` to get the `AppData` path, than append the the `cookies` path `\Google\Chrome\User Data\Default\Network\Cookies` to `Appdata` path `C:\Users\user\AppData\Local\`.It will be like this `C:\Users\user\AppData\Local\Google\Chrome\User Data\Default\Network\Cookies`

The malware uses the same way to get the all sensitive databases that contain sensitive data such as `Login Data`, `History` of browsers.

<p align="center">
  <img src="/assets/images/MA/warzonerat/4.png" />
</p>
<center><font size="3"> <u>Figure</u> Steal Cookies from browsers - sub_40DC9D <u></u> </font></center>
<br>

Next, the malware will go after the History of the user's browsers the same as stealing the cookies. For Chromium-based, quering `SELECT url, title, visit_count, last_visit_time FROM urls` and Mozzilla quering `SELECT url, title, visit_count, last_visit_date FROM moz_places`.

<p align="center">
  <img src="/assets/images/MA/warzonerat/5.png" />
</p>
<center><font size="3"> <u>Figure</u> Steal History from browsers - sub_40DC9D <u></u> </font></center>
<br>

In the next figure, the malware will steal the passwords and configurations of specific browsers. By quering `select signon_realm, origin_url, username_value, password_value from logins` from `logins` table of `Login Data` db.

<p align="center">
  <img src="/assets/images/MA/warzonerat/3.png" />
</p>
<center><font size="3"> <u>Figure</u> Steal password and configurations from browsers - sub_40DC9D <u></u> </font></center>
<br>

For Email serivices, the malware will go after outlook (`sub_4104A0`), Foxmail (`sub_410981`), Thunderbird (`sub_40FA23`) Email clients.\
As we can see in the next figure, the malware will steal the configurations and login data from Thunderbird email client.

<p align="center">
  <img src="/assets/images/MA/warzonerat/6.png" />
</p>
<center><font size="3"> <u>Figure</u> Steal Configurations from Thunderbird - sub_40FA23 <u></u> </font></center>
<br>

After stealing the sensitive data from browsers and Email clients, the malware will encrypt the stolen data using **customized RC4** encryption algorithm then send it to the C2 server. The malware uses `nevergonnagiveyouup` as encryption key to customized RC4 algorithm. After encryption, the malware will `send` it using sockets. 

<p align="center">
  <img src="/assets/images/MA/warzonerat/7.png" />
</p>
<center><font size="3"> <u>Figure</u> Customized RC4 encryption algorithm - sub_406244 <u></u> </font></center>
<br>

The list of targeted browsers
